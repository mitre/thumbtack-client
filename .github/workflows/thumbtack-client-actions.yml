name: thumbtack-client-test-build-deploy
on: [push]
jobs:
  test-build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Check out repository
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}
      - name: pip install
        run: pip install -r requirements.txt && pip install -e .
      - name: Run tests
        run: pytest
      - name: Build wheel
        run: pip install wheel && python setup.py sdist bdist_wheel
      - name: Get version/tag from GITHUB_REF
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: Create release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        uses: actions/create-release@v1
        id: create_release
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          release_name: ${{ env.RELEASE_VERSION  }}
          draft: false
          prerelease: false
      - name: Upload release zip
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/thumbtack-${{ env.RELEASE_VERSION  }}.tar.gz
          asset_name: thumbtack-${{ env.RELEASE_VERSION  }}.tar.gz
          asset_content_type: application/x-tar
      - name: Upload release wheel
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/thumbtack-${{ env.RELEASE_VERSION  }}-py2.py3-none-any.whl
          asset_name: thumbtack-${{ env.RELEASE_VERSION  }}-py2.py3-none-any.whl
      - name: Push to PyPI
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: "TAoqCYVptJwtiBibrFVKLTUBo8pnOl6jxNK1xSUSqmDw6UKuNzZcbFoNKWH7OMs72ekGKay0SJpHd8hSHEF85t7ogtlrHw9CtbyIOJBZPsIjp+hZmms8EeFw82z7P6DvrUrbdrrVurFea7nga5CxjllodbF4uhEx1OxWyIiYh+LJfhfeQOVOYyN6sShra6eOoZtmyQjfpisv2tMnTbNrItwi8uB8GPfsxY2sTesrjHb2gHLqgdTFTn0GE+nF+qb6TqmhZIoVGJjldotzLDeBpPtMe5a+B5WTibIr36MSAJGuu3uZj+YAwgQrKM0ux015AGRo3wRaOuZwLby71DWYTLwcb9EL1gXxflmAiSf9Znd2E+E/ssK9TVSQvLdkc59ZheBy9QbhNISKM9kOs3qScyORJsaPgflhWZnaV2SXybu0DdoWUKGJGGTHb2HwnGSqT4mUngir/DEtuZXaDxQI8ijAZbMRr7Tm+gEAFiM/KDCheMjnC+DQUcafnZjJJtY7bIMZ9DhHEjnGNSsJJYeGA+zLfiJOXjDFAvcOnGdfTaAjHxxoO+AvTF8Xkf5CGYfcgKxeIbkso8mr6QqWy7JjGCsXDa+Q/4er1zFg/IIgnbjhwcr6Q//cVOaGcbC2DgdCFiD06wG/vnU6czyS8T/waNe/ivHhEwmPbZZK/kZ5urg="
 
